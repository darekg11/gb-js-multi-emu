<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="GB Js Multi Emu - Website playground">
        <meta name="author" content="Dariusz GÃ³rak (https://www.github.com/darekg11)">

        <title>GB JS Multi Emu - Website playground</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.0/css/bulma.min.css">
        <link rel="stylesheet" href="./styles//index.css">
    </head>
    <body>
        <script src="scripts/runner.ts"></script>
        <section class="section">
            <div class="container">
                <div class="columns is-mobile is-centered">
                    <div class="column is-centered is-flex" style="justify-content: center;">
                        <canvas class="emulator-window" id="emulator_window" width="160" height="144"></canvas>
                    </div>
                  </div>
            </div>
        </section>
        <section class="section">
            <div class="container">
                <button onclick="window.openROMSelectionDialog()">LOAD ROM</button>
                <input id="rom_file_picker" accept=".gb,.bin" type="file" style="position: fixed; top: -100em;" />
            </div>
        </section>
        <section class="section">
            <div class="container">
                <button onclick="window.singleStep()">STEP</button>
                <button onclick="window.endLoop()">RUN UNTIL BIOS LOOP END</button>
            </div>
            <div class="container">
                <input id="debug_memory_index_input" class="input" placeholder="Enter memory index (HEX)">
                <button class="button" onclick="window.getMemoryValue()">SEARCH</button>
                <h3 id="debug_memory_value_index">MEMORY: </h3>
            </div>
        </section>
        <section class="section">
            <div class="container">
                <div class="columns">
                    <div class="column">
                        <h4>CPU DEBUG INFO:</h4>
                        <h3 id="debug_pc">PC: </h3>
                        <h3 id="debug_current_instruction">Current Instruction (HEX): </h3>
                        <h3 id="debug_reg_a">A: </h3>
                        <h3 id="debug_reg_b">B: </h3>
                        <h3 id="debug_reg_c">C: </h3>
                        <h3 id="debug_reg_d">D: </h3>
                        <h3 id="debug_reg_e">E: </h3>
                        <h3 id="debug_reg_f">F: </h3>
                        <h3 id="debug_reg_h">H: </h3>
                        <h3 id="debug_reg_l">L: </h3>
                        <h3 id="debug_reg_hl">HL: </h3>
                        <h3 id="debug_reg_de">DE: </h3>
                        <h3 id="debug_reg_sp">SP: </h3>
                        <h3 id="debug_zero_flag">Zero Flag state: </h3>
                        <h3 id="debug_subtraction_flag">Subtraction flag state: </h3>
                        <h3 id="debug_half_carry_flag">Half carry flag state: </h3>
                        <h3 id="debug_carry_flag">Carry flag state: </h3>
                    </div>
                    <div class="column">
                        <h4>ROM DEBUG INFO:</h4>
                        <h3 id="debug_rom_name">Name: </h3>
                        <h3 id="debug_rom_manufacturer">Manufacturer: </h3>
                        <h3 id="debug_rom_is_color">Color Gameboy support: </h3>
                        <h3 id="debug_rom_is_super">Super Gameboy support: </h3>
                        <h3 id="debug_rom_type">Type: </h3>
                    </div>
                </div>
            </div>
        </section>
    </body>
    <script>
        const runner = window.globalThis.runner;

        const pc_reg_info_element = document.getElementById("debug_pc");
        const current_instruction_info_element = document.getElementById("debug_current_instruction");
        const reg_a_info_element = document.getElementById("debug_reg_a");
        const reg_b_info_element = document.getElementById("debug_reg_b");
        const reg_c_info_element = document.getElementById("debug_reg_c");
        const reg_d_info_element = document.getElementById("debug_reg_d");
        const reg_e_info_element = document.getElementById("debug_reg_e");
        const reg_f_info_element = document.getElementById("debug_reg_f");
        const reg_h_info_element = document.getElementById("debug_reg_h");
        const reg_l_info_element = document.getElementById("debug_reg_l");
        const reg_hl_info_element = document.getElementById("debug_reg_hl");
        const debug_reg_de_element = document.getElementById("debug_reg_de");
        const reg_sp_info_element = document.getElementById("debug_reg_sp");
        const reg_memory_info_element = document.getElementById("debug_memory_value_index");
        const zero_flag_info_element = document.getElementById("debug_zero_flag");
        const subtraction_flag_info_element = document.getElementById("debug_subtraction_flag");
        const half_carry_flag_info_element = document.getElementById("debug_half_carry_flag");
        const carry_flag_info_element = document.getElementById("debug_carry_flag");
        const memory_index_input = document.getElementById("debug_memory_index_input");
        const debug_rom_name_element = document.getElementById("debug_rom_name");
        const debug_rom_manufacturer_element = document.getElementById("debug_rom_manufacturer");
        const debug_rom_is_color_element = document.getElementById("debug_rom_is_color");
        const debug_rom_is_super_element = document.getElementById("debug_rom_is_super");
        const debug_rom_type_element = document.getElementById("debug_rom_type");
        const rom_file_input = document.getElementById("rom_file_picker");
        memory_index_input.addEventListener("keyup", ({ key }) => {
            if (key === "Enter") {
                getMemoryValue();
                return false;
            }
        });

        rom_file_input.addEventListener("change", event => {
            const romFile = event && event.target && event.target.files && event.target.files[0] || null;
            if (!romFile) {
                return;
            };

            const reader = new FileReader();
            reader.addEventListener("load", (event) => {
                if (event.target.result) {
                    const romData = new Uint8Array(event.target.result);
                    runner.loadRom(romData);
                    getCPUDebugInfo();
                    getROMDebugInfo();
                }
            });
            reader.readAsArrayBuffer(romFile);
        });

        const openROMSelectionDialog = () => {
            rom_file_input.click();
        };

        const endLoop = () => {
            while (true) {
                runner.tick();
                const debugInfo = runner.getCPUDebugInfo();
                if (debugInfo.PC === 33) {
                    break;
                }
            }
            getCPUDebugInfo();
        };

        const singleStep = () => {
            runner.tick();
            getCPUDebugInfo();
        }

        const getMemoryValue = () => {
            const memoryIndex = Number.parseInt(memory_index_input.value, 16);
            console.log(memoryIndex);
            reg_memory_info_element.innerHTML = `Memory Index: 0x${memoryIndex.toString(16).toUpperCase()}, value: 0x${runner.getMemoryValue(memoryIndex).toString(16).toUpperCase()}`;
        }

        const getCPUDebugInfo = (memoryIndex = 0) => {
            const debugInfo = runner.getCPUDebugInfo();
            pc_reg_info_element.innerHTML = `PC: ${debugInfo.PC}`;
            reg_a_info_element.innerHTML = `A: 0x${debugInfo.A.toString(16).toUpperCase()}`;
            reg_b_info_element.innerHTML = `B: 0x${debugInfo.B.toString(16).toUpperCase()}`;
            reg_c_info_element.innerHTML = `C: 0x${debugInfo.C.toString(16).toUpperCase()}`;
            reg_d_info_element.innerHTML = `D: 0x${debugInfo.D.toString(16).toUpperCase()}`;
            reg_e_info_element.innerHTML = `E: 0x${debugInfo.E.toString(16).toUpperCase()}`;
            reg_f_info_element.innerHTML = `F: 0x${debugInfo.F.toString(16).toUpperCase()}`;
            reg_h_info_element.innerHTML = `H: 0x${debugInfo.H.toString(16).toUpperCase()}`;
            reg_l_info_element.innerHTML = `L: 0x${debugInfo.L.toString(16).toUpperCase()}`;
            reg_hl_info_element.innerHTML = `HL: 0x${debugInfo.HL.toString(16).toUpperCase()}`;
            debug_reg_de_element.innerHTML = `DE: 0x${debugInfo.DE.toString(16).toUpperCase()}`;
            reg_sp_info_element.innerHTML = `SP: 0x${debugInfo.SP.toString(16).toUpperCase()}`;
            zero_flag_info_element.innerHTML = `Zero Flag state: ${Number(debugInfo.ZERO_FLAG)}`;
            subtraction_flag_info_element.innerHTML = `Subtraction Flag state: ${Number(debugInfo.SUBTRACTION_FLAG)}`;
            half_carry_flag_info_element.innerHTML = `Half Carry Flag state: ${Number(debugInfo.HALF_CARRY_FLAG)}`;
            carry_flag_info_element.innerHTML = `Carry Flag state: ${Number(debugInfo.CARRY_FLAG)}`;
            current_instruction_info_element.innerHTML = `Current Instruction (HEX): 0x${runner.getMemoryValue(debugInfo.PC).toString(16).toUpperCase()}`;
        }

        const getROMDebugInfo = () => {
            const debugInfo = runner.getROMDebugInfo();
            debug_rom_name_element.innerHTML = `Name: ${debugInfo.NAME}`;
            debug_rom_manufacturer_element.innerHTML = `Manufacturer: ${debugInfo.MANUFACTURER}`;
            debug_rom_is_color_element.innerHTML = `Color Gameboy support: ${debugInfo.IS_COLOR && "YES" || "NO"}`;
            debug_rom_is_super_element.innerHTML = `Super Gameboy support: ${debugInfo.IS_SUPER && "YES" || "NO"}`;
            debug_rom_type_element.innerHTML = `Type: ${debugInfo.TYPE}`;
        }

        getCPUDebugInfo();
    </script>
</html>